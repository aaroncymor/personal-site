{% extends 'base2.html' %}

{% block head_extension %}
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
{% endblock %}

{% block content %}
<section class="posts">
    <div class="posts__search">
        <form method="post" action="">
            <div class="autocomplete-wrapper">
                <input
                    id="post-search-autocomplete"
                    type="text"
                    class="post-search">
            </div>
            <button>Search</button>
        </form>
    </div>
    <div class="posts__random-tags">
        <p>Try <a href="{% url 'post-random-tags' %}">random tag search</a></p>
    </div>
    <div class="posts__list">
        {% for post in posts %}
        <article class="posts__item">
            <h2 class="posts__title bantayog-font">{{ post.title }}</h2>
            <p class="posts__short-content nunito-font">
                {{ post.short_content_for_list }}
                <span class="posts__read-more">
                    Read more <a href="{% url 'post-detail' post.id %}">
                        here...
                    </a>
                </span>
            </p>
            <div class="posts__published">
                {% if post.published_date %}
                <p class="nunito-font">
                    Posted: 
                    <span>
                        {{ post.published_date | date:"M d, Y h:i a" }}
                    </span>
                </p>
                {% else %}
                <p class="nunito-font">Unpublished</p>
                {% endif %}
            </div>
            {% if post.tags.all %}
            <div class="posts__tags">
                <ul>
                    {% for tag in post.tags.all %}
                    <li><span>{{ tag }}</span></li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block javascript %}
<script>
    const postSearchInput = document.querySelector('#post-search-autocomplete');

    async function autoCompleteSearch(url='', data = {}) {
        const response = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        return response.json();
    }

    // clear input text on refresh
    window.onload = async () => {
        postSearchInput.value = "";
    }

    new autoComplete({
        data: {
            src: async () => {
                let postList = Array();
                let searchData = (postSearchInput.value.length > 2) ? postSearchInput.value : '';
                
                if (searchData.length > 2){
                    let postSearchResults = await autoCompleteSearch('/api/v1/autocomplete',
                                        { search: searchData}).then(data => data);

                    postSearchResults.forEach(postSearchResult=>{
                        postList.push(`${postSearchResult.title}-${postSearchResult.type}`);
                    });               
                }
                return postList;
            },
            cache: false
        },
        placeHolder: "Blog Posts...",
        threshold: 2,
        searchEngine: "loose",
        resultsList: {
            render: true,
            container: source => {
                source.setAttribute('class', 'post-search-list');
            },
            destination: document.querySelector('#post-search-autocomplete'),
            position: 'afterend',
            element: "div"
        },
        highlight: true,
        selector: '#post-search-autocomplete',
        resultItem: {
            content: (data, source) => {

                //console.log(data);
                let values = data.value.split(";");
                console.log(source);
                source.setAttribute('class', 'post-search-item');
                source.innerHTML = data.match;
            },
            element: "div"
        }
    });
</script>
{% endblock %}