{% extends 'base.html' %}
{% load static %}

{% block stylesheets %}
<!--Import Google Icon Font-->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!--Import Font Awesome-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!--Highlight JS-->
<link rel="stylesheet"
      href="{% static 'css/monokai-sublime.css' %}">

<!--Import materialize.css-->
<link type="text/css" rel="stylesheet" href="{% static 'css/materialize.min.css' %}"  media="screen,projection"/>

<!--Let browser know website is optimized for mobile-->
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
    a.decipher {
        color: black;
        text-decoration: none;
    }
    span.unlocked {
        text-decoration: underline;
        font-size: 1.2em;
    }
    p.post-title {
        font-size: 2em;
    }
    div.post-content-container {
        font-size: 1.1em;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="container">
    <h3 class="center-align">Blog</h3>
    <div class="divider"></div>
    {% if post %}
        <div class="post-container">
            <p class="post-title center-align">{{ post.title }}</p>
            <div class="post-content-container">
            {{ post.sanitized_content | safe }}
            </div>
        </div>
        {% if prev_page_session %}
            <a href="{% url 'post-list' %}?page={{ prev_page_session }}">Back</a>
            {% if request.session.authorized %}
            <a href="{% url 'post-form' %}?id={{ post.id }}&prev_page_session={{ prev_page_session }}">Edit</a>
            {% endif %}
        {% else %}
            <a href="{% url 'post-list' %}">Back</a>
            {% if request.session.authorized %}
            <a href="{% url 'post-form' %}?id={{ post.id }}">Edit</a>
            {% endif %}
        {% endif %}

        {% if deciphers %}
            {% for decipher in deciphers %}
            <div id="modal-{{ decipher.name }}" class="modal">
                <div class="modal-content">
                    <div id="aaroncymor-decipher-challenge">
                      <label>Challenge:</label>
                      {{ decipher.challenge | safe }}
                    </div>
                    <div id="aaroncymor-decipher-clue">
                      <label>Clue:</label>
                      <p>{{ decipher.clue }}</p>
                    </div>
                    <label>Code:</label>
                    <input type="hidden" data-target="{{ decipher.name }}" value="{% url 'api:decipher-check-code' decipher.id %}" />
                    <input type="text" name="code" />
                    <a id="btn-{{ decipher.name }}" href="javascript:void(0);">Submit</a>
                </div>
                <div class="modal-footer">
                    <!--<a href="#!" class="modal-close">Close</a>-->
                </div>
            </div> 
            {% endfor %}
        {% endif %}
    {% endif %}
</div>
{% endblock content %}

{% block javascript %}
<script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/materialize.min.js' %}"></script>
<script src="{% static 'js/highlight.pack.js' %}"></script>
<script type="text/javascript">

    $(document).ready(function(){
        $('.sidenav').sidenav();
        $('.collapsible').collapsible();
        $('.modal').modal();
        $('.tooltipped').tooltip();
        $('pre code').each(function(i, e) {hljs.highlightBlock(e)});

        $('a[id^=btn-decipherme-]').on('click', function(){
            
            // get modal instance from this parent element
            var modal = $(this).parent().parent()[0].M_Modal;
            
            // Previous element of button is text
            var inputTxtCode = $(this).prev();
            var codeVal = inputTxtCode.val();

            // Previous element of text is input:hidden with endpoint value
            var hiddenInput = $(this).prev().prev();
            var target = hiddenInput.data("target");
            var endpoint = hiddenInput.val();

            // Pass user input of code to API
            var data = { code: codeVal };
            
            // Ajax POST
            $.post(endpoint, data)
            .fail(function(error){
                console.log(error);
                if(error.hasOwnProperty("responseJSON")){
                    responseJSON = error.responseJSON;
                    if(responseJSON.hasOwnProperty("error")){
                        M.toast({html: responseJSON.error, classes: 'rounded red lighten-1'});
                        inputTxtCode.val("");
                    } else if(responseJSON.hasOwnProperty("detail")) {
                        M.toast({html: responseJSON.detail, classes: 'rounded red lighten-1'});
                        inputTxtCode.val("");
                    }
                };
            })
            .done(function(data){
                if(data.hasOwnProperty("hidden_text")){
                    modal.close();
                    inputTxtCode.val("");

                    toReplace = $('#' + target);

                    // Get the element that will replace anchor tag
                    unLockElem = $('#' + target + '-unlock');
                    toReplace.delay(500).fadeOut(100, function(){
                        $(this).replaceWith(unLockElem).fadeIn(50);
                        unLockElem.show().fadeOut('slow', function(){
                            hiddenText = '<span class="unlocked">' + data.hidden_text + '</span>'
                            $(this).replaceWith(hiddenText).fadeIn('slow');
                        });
                    });
                };
            });
        })
    });
</script>
{% endblock javascript %}